
{% load a %}

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="//code.jquery.com/jquery-1.11.2.js"></script>
    <script>
        $(window).load(function() {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            function sameOrigin(url) {
                // test that a given url is a same-origin URL
                // url could be relative or scheme relative or absolute
                var host = document.location.host; // host + port
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                // Allow absolute or scheme relative URLs to same origin
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                            // or any other URL that isn't scheme relative or absolute i.e relative.
                        !(/^(\/\/|http:|https:).*/.test(url));
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                        // Send the token to same-origin, relative URLs only.
                        // Send the token only if the method warrants CSRF protection
                        // Using the CSRFToken value acquired earlier
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });


        });
        $(function(){
// Sets the initial state in the browser, so back/forward will
    // work with the landing site
    history.replaceState({
        title: window.location.pathname,
        target: 'body',
        container: $('body').html()
    });

    function link_helper(e){
       e.preventDefault();
        var insert = $(this).attr('insert');
        request(this, insert, this.href);
    }

    function form_helper(e){
       e.preventDefault();
        alert(1);
        var data = $(this).serializeArray();
        request(this, "append", this.action, data);
    }

    $.fn.extend({
        bindOctopus: function(){
            //alert($('body').find('.octopus-form').length);
            if (this.hasClass('.octopus-link')){
                $(this).bind('click', link_helper);
            }
            if (this.hasClass(".octopus-form")){
                $(this).on('submit', form_helper);
                alert(1);
            }

            $(this).find('.octopus-link').on('click', link_helper);
            $(this).find('.octopus-form').bind('submit', form_helper);

        }
    });

    function request(obj, insert, href, dataArray){

        var title = new String;  var content = new String;
        var error_content;  // container for error messages
        var state = {};     // Dict to pass to pushState

        dataArray = dataArray || {};

        $.ajax({
            url: href,
            type: $(obj).attr('method'),
            data: dataArray
        }).done(function(data){
            title = obj.title;

            switch(insert){
                case "append":
                    content = $(obj.target).html() + data;
                    break;
                case "prepend":
                    content = data + $(obj.target).html();
                    break;
                case "replace":
                    content = data;
            }

        }).fail(function( jqXHR, textStatus, errorThrown){
            title = content = error_content = jqXHR.status+" "+errorThrown;
        }).always(function(data){
            data = !error_content ? data : error_content;

            state = {
                title: title,
                target: obj.target,
                container: content
            };

            switch(insert){
                case 'prepend':
                    var elem = $(document.createElement('div')).html(data).hide();
                    $(obj.target).prepend(elem);
                    $(elem).slideDown("fast", $(this).bindOctopus());
                    break;
                case 'append':
                    var elem = $(document.createElement('div')).html(data).hide();
                    $(obj.target).append(elem);
                    $(elem).slideDown("fast", $(this).bindOctopus());
                    break;
                default:
                    $(obj.target).fadeOut('fast', function() {
                        $(this).html(data).fadeIn('fast',
                                $(this).bindOctopus());
                        $('title').text(title);
                    });
            }
            window.history.pushState(state, "", href);

        });
    }


    $('.octopus-link').on('click', link_helper);
    $('.octopus-form').on('submit', form_helper);

    $(window).on('popstate', function(event) {
        var state = event.originalEvent.state;

        if (state) {
            $(state.target).html(state.container );
            $('title').text(state.title);
        }
    });
});
    </script>
</head>
<body>
<nav>
    <li>{% a 'home(replace)' '#main' 'home' %}</li>
    <li>{% a 'detail(replace)' '#main' 'detail' 1 title="balls"%}</li>
    <li>{% a 'list(append)' '#main' 'list' insert="append" %}</li>
    <li>{% a 'archive(prepend)' '#main' 'archive' insert="prepend" %}</li>
    <li>{% a 'create' '#main' 'create' insert="append" %}</li>
    <li>{% a '404(prepend)' '#main' '/asdfdsf/sdfsa/sf' insert="replace" %}</li>

</nav>
<div id="main">{% block content %}Hello {% endblock content %}</div>
</body>
<footer>
</footer>

</html>